name: CodeQL

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 0 * * 0" # Weekly Sunday 00:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  analyze:
    name: CodeQL (C/C++)
    runs-on: ubuntu-24.04
    env:
      CMAKE_GENERATOR: Ninja
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Install toolchain and PostgreSQL 17 dev headers so the build succeeds with -DPG_CONFIG
      - name: Setup compiler toolchain
        uses: ./.github/actions/setup-compiler
        with:
          compiler: gcc
          gcc-version: "14"
          llvm-version: "20"

      - name: Setup PostgreSQL (headers + pg_config)
        uses: ./.github/actions/setup-postgres
        with:
          pg-major: "17"

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: cpp

      # Manual build so CodeQL can observe the compilation
      - name: Configure
        run: |
          cmake -S . -B build \
            -G "${CMAKE_GENERATOR}" \
            -DCMAKE_BUILD_TYPE=Debug \
            -DPG_CONFIG="${PG_CONFIG}" \
            -DCMAKE_C_COMPILER="${CC}" \
            -DCMAKE_CXX_COMPILER="${CXX}"
      - name: Build
        run: cmake --build build -j

      - name: Install
        run: sudo cmake --install build

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:cpp"
